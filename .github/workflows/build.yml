name: Build StageView

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  # ───────────────────────────────────────────────────────────────────────────
  # Windows x64 — produces MSI + NSIS installer
  # ───────────────────────────────────────────────────────────────────────────
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install npm dependencies
        run: npm ci

      - name: Download ffmpeg for Windows
        shell: pwsh
        run: |
          $binDir = "src-tauri/binaries"
          $ffmpegUrl = "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip"
          $zipPath = "$binDir/ffmpeg.zip"
          Invoke-WebRequest -Uri $ffmpegUrl -OutFile $zipPath
          Expand-Archive -Path $zipPath -DestinationPath "$binDir/temp" -Force
          $ffmpegExe = Get-ChildItem -Path "$binDir/temp" -Recurse -Filter "ffmpeg.exe" | Select-Object -First 1
          Copy-Item $ffmpegExe.FullName "$binDir/ffmpeg-x86_64-pc-windows-msvc.exe"
          Remove-Item "$binDir/temp" -Recurse -Force
          Remove-Item $zipPath -Force

      - name: Build Tauri app
        run: npx tauri build

      - name: Upload Windows installers
        uses: actions/upload-artifact@v4
        with:
          name: StageView-Windows-x64
          path: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/nsis/*.exe
          if-no-files-found: error

  # ───────────────────────────────────────────────────────────────────────────
  # Linux x64 — produces .deb + AppImage
  # ───────────────────────────────────────────────────────────────────────────
  build-linux-x64:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install npm dependencies
        run: npm ci

      - name: Download ffmpeg for Linux x64
        run: |
          FFMPEG_URL="https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-linux64-gpl.tar.xz"
          curl -L "$FFMPEG_URL" -o /tmp/ffmpeg.tar.xz
          mkdir -p /tmp/ffmpeg-extract
          tar -xf /tmp/ffmpeg.tar.xz -C /tmp/ffmpeg-extract --strip-components=1
          cp /tmp/ffmpeg-extract/bin/ffmpeg src-tauri/binaries/ffmpeg-x86_64-unknown-linux-gnu
          chmod +x src-tauri/binaries/ffmpeg-x86_64-unknown-linux-gnu

      - name: Build Tauri app
        run: npx tauri build

      - name: Upload Linux packages
        uses: actions/upload-artifact@v4
        with:
          name: StageView-Linux-x64
          path: |
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/appimage/*.AppImage
          if-no-files-found: error

  # ───────────────────────────────────────────────────────────────────────────
  # Linux ARM64 (Raspberry Pi) — produces .deb
  # Cross-compiled from x64 using Docker + QEMU
  # ───────────────────────────────────────────────────────────────────────────
  build-linux-arm64:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU for ARM64 emulation
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Download ffmpeg for ARM64
        run: |
          FFMPEG_URL="https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-linuxarm64-gpl.tar.xz"
          curl -L "$FFMPEG_URL" -o /tmp/ffmpeg-arm64.tar.xz
          mkdir -p /tmp/ffmpeg-arm64
          tar -xf /tmp/ffmpeg-arm64.tar.xz -C /tmp/ffmpeg-arm64 --strip-components=1
          cp /tmp/ffmpeg-arm64/bin/ffmpeg src-tauri/binaries/ffmpeg-aarch64-unknown-linux-gnu
          chmod +x src-tauri/binaries/ffmpeg-aarch64-unknown-linux-gnu

      - name: Build in ARM64 Docker container
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: ubuntu22.04
          githubToken: ${{ github.token }}
          dockerRunArgs: |
            --volume "${PWD}:/workspace"
          install: |
            apt-get update
            apt-get install -y \
              curl \
              build-essential \
              pkg-config \
              libwebkit2gtk-4.1-dev \
              libgtk-3-dev \
              libayatana-appindicator3-dev \
              librsvg2-dev \
              patchelf \
              libssl-dev \
              file
            # Install Rust
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            # Install Node.js 20
            curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
            apt-get install -y nodejs
          run: |
            source "$HOME/.cargo/env"
            cd /workspace
            npm ci
            npx tauri build
            # Copy outputs to a known location
            mkdir -p /workspace/dist
            cp src-tauri/target/release/bundle/deb/*.deb /workspace/dist/ 2>/dev/null || true

      - name: Upload Raspberry Pi package
        uses: actions/upload-artifact@v4
        with:
          name: StageView-RaspberryPi-ARM64
          path: |
            dist/*.deb
            src-tauri/target/release/bundle/deb/*.deb
          if-no-files-found: warn

  # ───────────────────────────────────────────────────────────────────────────
  # Create GitHub Release (only on tag push)
  # ───────────────────────────────────────────────────────────────────────────
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-windows, build-linux-x64, build-linux-arm64]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f | head -20

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          generate_release_notes: true
          files: |
            artifacts/StageView-Windows-x64/*
            artifacts/StageView-Linux-x64/*
            artifacts/StageView-RaspberryPi-ARM64/*
